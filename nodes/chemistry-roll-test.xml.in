<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
The chemistry roll installation test.
</description>

<copyright>
Copyright (c) 2000 - 2011 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<post>

/bin/mkdir -m 0755 /root/rolltests

<file name="/root/rolltests/chemistry.t" perms="0755">
<![CDATA[#!/usr/bin/perl -w

use Test::More qw(no_plan);

my $appliance = $#ARGV >= 0 ? $ARGV[0] :
                -d '/export/rocks/install' ? 'Frontend' : 'Compute';
my $isCompute = $appliance eq 'Compute';
my $isFe = $appliance eq 'Frontend';
my $isLogin = $appliance eq 'Login';
my $output;
my $TESTFILE = 'tmpchemistry';

# apbs
ok($isCompute == -d '/opt/apbs', 'apbs is/is not installed');
SKIP: {

  skip 'apbs not installed', 1 if ! -d '/opt/apbs';
  skip 'apbs test not installed', 1 if ! -d '/opt/apbs/examples/actin-dimer';
  open(OUT, ">$TESTFILE.sh");
  print OUT <<END;
. /etc/profile.d/modules.sh
module load ROLLCOMPILER apbs
cd /opt/apbs/examples/actin-dimer
/opt/apbs/bin/apbs apbs-smol-auto.in
END
  close(OUT);
  $output = `/bin/bash $TESTFILE.sh`;
  ok($output =~ /Global.*energy.*\d+\.\d+.*kJ\/mol/, 'apbs sample run');

}

# lammps
ok($isCompute == -d '/opt/lammps', 'lammps is/is not installed');
SKIP: {

  skip 'lammps not installed', 1 if ! -d '/opt/lammps';
  skip 'lammps test not installed', 1 if ! -d '/opt/lammps/examples/colloid';
  open(OUT, ">$TESTFILE.sh");
  print OUT <<END;
. /etc/profile.d/modules.sh
module load ROLLCOMPILER openmpi_ROLLNETWORK lammps
cd /opt/lammps/examples/colloid
hostname > nodes
mpirun -np 1 -machinefile nodes /opt/lammps/bin/lammps < in.colloid
/bin/rm -f nodes
END
  close(OUT);
  $output = `/bin/bash $TESTFILE.sh`;
  ok($output =~ /900 atoms/, 'lammps sample run');

}


`rm -f $TESTFILE*`;
]]>
</file>

</post>

</kickstart> 
